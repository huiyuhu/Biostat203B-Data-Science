---
title: "Biostat M280 Homework 3"
subtitle: Due Mar 3 @ 11:59PM
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Q1 LA City Employee Payroll

The `/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv` file on teaching server contains payroll information of LA City employees in years 2013-2017. It was downloaded from [LA City Controller's Office](https://controllerdata.lacity.org/Payroll/City-Employee-Payroll/pazn-qyym). Make a Shiny app to facilitate exploratory data analysis. 

1. For efficiency of the Shiny app, you should first pre-process, pare down, tidy, and save the data, e.g., as a compressed RDS file, to be used in the app.
```{r}
##prepare:
library(tidyverse)
library(shiny)
fluidPage()
payroll <- read_csv("/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv")
###### Data set for question 1 ######
TotPay_wide <- payroll %>% 
  group_by(Year) %>%
  summarise(base = sum(as.numeric(gsub("\\$", "", `Base Pay`)), na.rm = TRUE),
            overtime = sum(as.numeric(gsub("\\$", "", `Overtime Pay`)), 
                           na.rm = TRUE),
            other = sum(as.numeric(gsub("\\$", "", `Other Pay (Payroll Explorer)`
                                        )), na.rm = TRUE), 
            total = sum(base, overtime, other)) 
Totpay <- gather(TotPay_wide, class, payment, base:other, factor_key=TRUE)
write_rds(TotPay, "totpay.rds")

###### Data set for question 2 ######
highpay <- payroll %>% 
select(Year, `Department Title`, `Job Class Title`, `Total Payments`, `Base Pay`,
       `Overtime Pay`,`Other Pay (Payroll Explorer)`) %>% 
  arrange(Year, desc(as.numeric(gsub("\\$", "", `Total Payments`)))) 
write_rds(highpay, "highpay.rds")

###### Data set for question 3 ######
meanpay <- payroll %>%
  group_by(Year,`Department Title`) %>%
  summarise(`Mean Total Pay` =  mean(as.numeric(gsub("\\$", "",`Total Payments`)),
                                    na.rm = TRUE),
            `Mean Base Pay` = mean(as.numeric(gsub("\\$", "", `Base Pay`)), 
                                   na.rm = TRUE),
            `Mean Overtime Pay` = mean(as.numeric(gsub("\\$", "",`Overtime Pay`)),
                                       na.rm = TRUE),
            `Mean Other Pay` = mean(as.numeric(gsub("\\$", "", 
                                    `Other Pay (Payroll Explorer)`)),
                                    na.rm = TRUE)
            ) %>% arrange( Year, desc( `Mean Total Pay` ))
write_rds(meanpay, "meanpay.rds")

medpay <- payroll %>%
  group_by(`Department Title`, Year) %>%
  summarise(`Median Total Pay` =  median(as.numeric(gsub("\\$", "",`Total Payments`)),
                                    na.rm = TRUE),
            `Median Base Pay` = median(as.numeric(gsub("\\$", "", `Base Pay`)), 
                                   na.rm = TRUE),
            `Median Overtime Pay` = median(as.numeric(gsub("\\$", "",`Overtime Pay`)),
                                       na.rm = TRUE),
            `Median Other Pay` = median(as.numeric(gsub("\\$", "", 
                                    `Other Pay (Payroll Explorer)`)),
                                    na.rm = TRUE)
            ) %>%  arrange( Year, desc( `Median Total Pay` ) )
write_rds(medpay, "medpay.rds")

###### Data set for question 4 ######
cost <- payroll %>% 
  group_by(Year,`Department Title`) %>%
  summarise(`Total Pay` =  sum(as.numeric(gsub("\\$", "",`Total Payments`)),
                                    na.rm = TRUE),
            `Base Pay` = sum(as.numeric(gsub("\\$", "", `Base Pay`)), 
                                   na.rm = TRUE),
            `Overtime Pay` = sum(as.numeric(gsub("\\$", "",`Overtime Pay`)),
                                       na.rm = TRUE),
            `Other Pay` = sum(as.numeric(gsub("\\$", "", 
                                    `Other Pay (Payroll Explorer)`)),
                                     na.rm = TRUE),
            `Total Cost` = sum(as.numeric(gsub("\\$", "", `Average Benefit Cost`)),
                                       na.rm = TRUE)
            ) %>% arrange( Year, desc( `Total Cost` )) %>% 
            select(Year, `Department Title`, `Total Pay`, `Base Pay`, 
                   `Overtime Pay`, `Other Pay`, `Total Cost`)
write_rds(cost, "cost.rds")
```

0. **Total payroll by LA City**. Visualize the total LA City payroll of each year, with breakdown into base pay, overtime pay, and other pay.

```{r}
totpay <- readRDS("totpay.rds")
ui <- fluidPage(
  plotOutput(outputId = "Totpay_plot")
)
server <- function(input, output) {
  output$Totpay_plot <- renderPlot({
    ggplot(data = totpay, aes(x = Year, y = payment, fill = class)) +
    geom_bar(stat="identity")
  })
}
shinyApp(ui = ui, server = server)
```


0. **Who earned most?** Visualize the payroll information (total payment with breakdown into base pay, overtime pay, and other pay, Department, Job Title) of the top $n$ highest paid LA City employees in a specific year. User specifies $n$ (default 10) and year (default 2017).
```{r}
highp <- readRDS("highpay.rds")
ui <- fluidPage(
  numericInput("rows", "Choose number of row:", 10, min = 0, max = 20),
  numericInput("year", "Choose a year:", 2017, min = 2013, max = 2017),

  tableOutput(outputId = "high_pay")
)
server <- function(input, output) {
  output$high_pay <- renderTable({
    highp %>% filter(Year == input$year) %>% 
    head(input$rows)
  })
}
shinyApp(ui = ui, server = server)
```

0. **Which departments earn most?** Visualize the mean or median payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ earning departments. User specifies $n$ (default 5), year (default 2017), and method (mean or median, default median).
```{r}
meanp <- readRDS("meanpay.rds")
medp <- readRDS("medpay.rds")
ui <- fluidPage(
  numericInput("rows", "Choose number of row:", 5, min = 0, max = 20),
  numericInput("year", "Choose a year:", 2017, min = 2013, max = 2017),
  radioButtons("method", "Choose a method:", c("Mean","Median"), "Median"),
  tableOutput(outputId = "mpay")
)
server <- function(input, output) {
  output$mpay <- renderTable({
    if (input$method == "Mean"){
      meanp %>% filter(Year == input$year) %>% 
      head(input$rows)
    } else {
      medp  %>% filter(Year == input$year) %>% 
      head(input$rows)
    }
  })
}
shinyApp(ui = ui, server = server)
```

0. **Which departments cost most?** Visualize the total payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ expensive departments. User specifies $n$ (default 5) and year (default 2017).
```{r}
 cost <- readRDS("cost.rds")
ui <- fluidPage(
  numericInput("rows", "Choose number of row:", 5, min = 0, max = 20),
  numericInput("year", "Choose a year:", 2017, min = 2013, max = 2017),

  tableOutput(outputId = "high_cost")
)
server <- function(input, output) {
  output$high_cost <- renderTable({
    cost %>% filter(Year == input$year) %>% 
    head(input$rows)
  })
}

shinyApp(ui = ui, server = server)
```

0. Visualize any other information you are interested in.

0. Publish your Shiny app to <https://www.shinyapps.io> and share the link.

## Q2 LA City Parking War

The SQLite database `/home/m280-data/la_parking/LA_Parking_Citations.sqlite` on teaching server contains information about parking tickets in LA City. It was downloaded from [LA Open Data Portal](https://data.lacity.org/A-Well-Run-City/Parking-Citations/wjz9-h9np). Connect to the database and answer following questions using plots and summary statistics. In this exercise, you are **not** allowed to load whole data into memory. Use the _transform in database, plot in R_ strategy.
```{r}
#Prepare
library("DBI")
library("RSQLite")
library("tidyverse")
library("lubridate")
library("magrittr")

#Connect
con = dbConnect(RSQLite::SQLite(), "/home/m280-data/la_parking/LA_Parking_Citations.sqlite")
str(con)
dbListTables(con)
latix_sql <- dplyr::tbl(con, "latix")
str(latix_sql)
knitr::opts_chunk$set(connection = "con")
```


1. How many tickets are in this data set? Which time period do these tickets span? Which years have most data?
```{sql connection="con"}
SELECT COUNT(DISTINCT Ticket_number) AS tick_num FROM latix;
```

* There are `4044338` tickets (distinct) in this data sets.

```{sql connection="con"}
--SELECT MAX(Issue_DateTime) AS "Max Date", MIN(Issue_DateTime) AS "Min Date" FROM latix;
SELECT DATETIME(MAX(Issue_DateTime), 'unixepoch') AS "Max TIME",
        DATETIME(MIN(Issue_DateTime), 'unixepoch') AS "Min TIME" 
FROM latix;
```

* The time period is `from 2010-04-27 21:40:00 UTC to 2017-12-30 01:41:00 UTC`.

```{sql connection="con"}
SELECT 
  strftime('%Y', DATETIME(Issue_DateTime, 'unixepoch')) AS Year, 
  COUNT(*) AS Number
FROM latix
WHERE Issue_DateTime IS NOT NULL
GROUP BY 1
ORDER BY 2 DESC
LIMIT  1;
```

* `2015` has most of the data. 

0. When (which hour, weekday, month day, and month) are you most likely to get a ticket and when are you least likely to get a ticket?
* For Hour:
```{r}
sqlstr_hour <- 
  "SELECT 
    strftime('%H', DATETIME(Issue_DateTime, 'unixepoch')) AS Hour
  FROM latix
  WHERE Issue_DateTime IS NOT NULL
"
hour <- dbGetQuery(con, sqlstr_hour) 
ggplot(hour, aes(Hour)) + geom_bar()

sqlstr_hour1 <-   
  "SELECT
    strftime('%H', DATETIME(Issue_DateTime, 'unixepoch')) AS Hour,
    COUNT(*) AS Number
  FROM latix
  WHERE Issue_DateTime IS NOT NULL
  GROUP BY 1
  ORDER BY 2
"
hour1 <- dbGetQuery(con, sqlstr_hour1) 
hour1
```
* Based on the barchart above, it most likely to get a ticket at `12` and least likely to get a ticket at `5`. In addition, the summary of count can also confirm this result.

* For weekday: 
```{r}
sqlstr_weekday <- 
  "SELECT 
    strftime('%w', DATETIME(Issue_DateTime, 'unixepoch')) AS Weekday
  FROM latix
  WHERE Issue_DateTime IS NOT NULL
"
weekday <- dbGetQuery(con, sqlstr_weekday) 
ggplot(weekday, aes(Weekday)) + geom_bar()

sqlstr_weekday1 <-   
  "SELECT
    strftime('%w', DATETIME(Issue_DateTime, 'unixepoch')) AS Weekday,
    COUNT(*) AS Number
  FROM latix
  WHERE Issue_DateTime IS NOT NULL
  GROUP BY 1
  ORDER BY 2
"
weekday1 <- dbGetQuery(con, sqlstr_weekday1) 

```
* Based on the barchart above, it most likely to get a ticket on `Tuesday` and least likely to get a ticket on `Saturday`. In addition, the summary of count can also confirm this result.

* For month day:
```{r}
sqlstr_mday <- 
  "SELECT 
    strftime('%d', DATETIME(Issue_DateTime, 'unixepoch')) AS Mday
  FROM latix
  WHERE Issue_DateTime IS NOT NULL
"
mday <- dbGetQuery(con, sqlstr_mday) 
ggplot(mday, aes(Mday)) + geom_bar()

sqlstr_mday1 <-   
  "SELECT
    strftime('%d', DATETIME(Issue_DateTime, 'unixepoch')) AS Mday,
    COUNT(*) AS Number
  FROM latix
  WHERE Issue_DateTime IS NOT NULL
  GROUP BY 1
  ORDER BY 2
"
mday1 <- dbGetQuery(con, sqlstr_mday1) 
mday1
```
* Based on the barchart above, it most likely to get a ticket on day `22` in a month and least likely to get a ticket on day `31` in a month. In addition, the summary of count can also confirm this result.

* For month:
```{r}
sqlstr_month <- 
  "SELECT 
    strftime('%m', DATETIME(Issue_DateTime, 'unixepoch')) AS Month
  FROM latix
  WHERE Issue_DateTime IS NOT NULL
"
month <- dbGetQuery(con, sqlstr_month) 
ggplot(month, aes(Month)) + geom_bar()

sqlstr_month1 <-   
  "SELECT
    strftime('%m', DATETIME(Issue_DateTime, 'unixepoch')) AS Month,
    COUNT(*) AS Number
  FROM latix
  WHERE Issue_DateTime IS NOT NULL
  GROUP BY 1
  ORDER BY 2
"
month1 <- dbGetQuery(con, sqlstr_month1) 
month1
```
* Based on the barchart above, it most likely to get a ticket in `March` and least likely to get a ticket in `November`. In addition, the summary of count can also confirm this result.

0. Which car makes received most citations?
```{r}
sqlstr_car <- 
 "SELECT
    Make AS Car,
    COUNT(*) AS Number
  FROM latix
  WHERE Make IS NOT NULL
  GROUP BY 1
  ORDER BY 2 DESC
  LIMIT 1
"
dbGetQuery(con, sqlstr_car) 
```
* The `TOYOTA` received most citations.

0. How many different colors of cars were ticketed? Which color attracted most tickets?
```{r}
qlstr_color <- 
 "SELECT
    Color AS Color,
    COUNT(*) AS Number
  FROM latix
  WHERE Color IS NOT NULL
  GROUP BY 1
  ORDER BY 2 DESC
"
color <- dbGetQuery(con, qlstr_color) 
color[1,]
nrow(color)

```
* There are `65` different colors of cars were ticketedThe `Black` car attracted most tickets.

0. What are the most common ticket types?
```{r}

```

0. How much money was collected on parking tickets in 2015 and 2016?
```{r}
sqlstr_money <-   
  "SELECT
    strftime('%Y', DATETIME(Issue_DateTime, 'unixepoch')) AS Year,
    SUM(Fine_amount) AS Money
  FROM latix
  WHERE Issue_DateTime IS NOT NULL
  GROUP BY 1
"
money <- dbGetQuery(con, sqlstr_money)
money[money$Year == "2015",2] + money[money$Year == "2016",2]

```
* `$ 274242930` was collected on parking tickets in 2015 and 2016.

0. Visualize any other information you are interested in.
