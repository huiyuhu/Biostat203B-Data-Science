---
title: "Biostat M280 Homework 4"
subtitle: Due Mar 16 @ 11:59PM
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(sparklyr)
library(dplyr)
library(ggplot2)
Sys.setenv(SPARK_HOME="/usr/lib/spark")
config <- spark_config()
sc <- spark_connect(master = "yarn-client", config = config)
#spark_disconnect_all()
```

```{r}
#Access Hive tables
flights_tbl <- tbl(sc, 'flights')
#flights_tbl %>% print(width = Inf)
airlines_tbl <- tbl(sc, 'airlines')
airports_tbl <- tbl(sc, 'airports')
#airports_tbl %>% print(width = Inf)
flight2000 <- flights_tbl %>% 
  filter(year == 2000)
#flight2000 %>% print(width = Inf)
LAX <- flights_tbl %>% 
  filter(origin == "LAX" || dest == "LAX") 
LAX_traf <- LAX %>% 
  group_by(year, month, dayofmonth, dayofweek) %>%
  summarise(n = n()) %>%
  collect()
LAX2000_dest <- flight2000 %>%
  filter(origin == "LAX") %>%
  group_by(dest) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  head(10)
#LAXtraf %>% print(width = Inf)
```

Our Apache Yarn cluster hosts the [flights](http://stat-computing.org/dataexpo/2009/the-data.html) data representing 123 million flights over 22 years. Read the [lecture notes](http://hua-zhou.github.io/teaching/biostatm280-2018winter/slides/12-sparklyr/sparklyr-flights.html) on how to access the Yarn cluster. Connect to the database using `sparklyr` and answer following questions. You can base your answers on a specific year or the whole data set.
#### My project was based on the data in year 2000.
1. Map the top 10 busiest airports. Size of dots should reflect the number of flights through that destination.  
Hint: You may find this tutorial on [Making Maps in R](http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html) helpful.
```{r}
# map pakeages 
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)

#find top 10 busy airport in year 2000
busy <- flight2000 %>%
  group_by(dest) %>% 
  summarise(faa = dest, n = n()) %>% 
  arrange(desc(n)) %>%
  head(10) %>% 
  collect()
# innerjoin by airport name (faa)
busy_ap <- inner_join(busy, airports_tbl, by = "faa", 
                      copy = T) %>%
            arrange(desc(n))
busy_ap$lat <- as.numeric(busy_ap$lat)
busy_ap$lon <- as.numeric(busy_ap$lon)

usa <- map_data("usa")
gg1 <- ggplot() + 
  geom_polygon(data = usa, aes(x = long, y = lat, group = group),
               fill = "navajowhite", color = "navajowhite4") + 
    coord_fixed(1.3) + 
  geom_point(data = busy_ap, aes(x = lon, y = lat, size = n )) + 
  geom_text(data = busy_ap, aes(lon, lat, label=dest,
                                colour = factor(dest), fontface = "bold"))
gg1
```

2. Map the top 10 busiest direct routes. Size of lines should reflect the number of flights through that route.
```{r}
busyroutes <- flight2000 %>%
  group_by(origin,dest) %>% 
  summarise(n = n()) %>% 
  arrange(desc(n)) %>%
  head(10) %>% 
  collect()
route_ori <- inner_join(busyroutes, airports_tbl,  
                        by = c("origin" = "faa"), copy = T) %>%
             select(origin, n, lat, lon)
route_ori$lat <- as.numeric(route_ori$lat)
route_ori$lon <- as.numeric(route_ori$lon)
route_ori$class <- "origin"

route_dest <- inner_join(busyroutes, airports_tbl,  
                        by = c("dest" = "faa"), copy = T) %>%
              ungroup() %>%
             select(dest, n, lat, lon)
route_dest$lat <- as.numeric(route_dest$lat)
route_dest$lon <- as.numeric(route_dest$lon)
route_dest$class <- "dest"

toproute <- bind_rows(route_ori, route_dest) 
#toproute$n <- as.factor(toproute$n)
usa <- map_data("usa")
gg2 <- ggplot() + 
  geom_polygon(data = usa, aes(x = long, y = lat, group = group),
               fill = "azure2", color = "azure4") + 
    coord_fixed(1.3) + 
  geom_point(data = toproute, aes(x = lon, y = lat, color = class, shape = class)) + 
  geom_line(data = toproute, aes(x = lon, y = lat, group = n, size = n))
 gg2 
```

3. LAX:
  
    <p align="center">
    ![](./lax-by-day-98-08.png)
    </p>

    (a). Reproduce above plot. Visualize and explain some prominent features you observe. For example, what happened at points 1-5?
```{r}
LAX_traf$date <- as.Date(paste(LAX_traf$year, LAX_traf$month, LAX_traf$dayofmonth, sep='-'))

break.vec <- seq(from=as.Date("1998-01-01"), to=as.Date("2008-01-01"), by="year")
gg3 <- ggplot() +
  geom_line(data = LAX_traf, aes(x = date, y = n)) + 
  scale_x_date(breaks = break.vec,date_labels = "%Y", limits = as.Date(c('1998-1-1', '2009-1-1'))) +
  coord_fixed(ratio=1.2) +
  ggtitle("LAX air traffic") +  
  geom_label(label = c("5","1","3","2","4"), 
             aes(x = as.Date(c('2001-1-1', '2001-9-30', '2004-7-1', '2004-12-1', '2008-1-1')), 
             y = c(1200, 1070, 960, 930, 1200)))
gg3
```

    (b). Visualize and explain seasonal effects.
    * Answer based on the flight in 2000
```{r}
LAX2000 <- LAX_traf %>% 
  filter(year == 2000)

LAX2000$season <- (LAX2000$month%/%4 + 1)
#table to show seasonal difference
LAX2000 %>% 
  group_by(season) %>%
  summarise(traffic_n = sum(n))
#plot to show seasonal difference
gg4 <- ggplot() +
  geom_line(data = LAX2000, aes(x = date, y = n)) + 
  scale_x_date(date_breaks = "1 month",date_labels = "%m", limits = as.Date(c('2000-1-1', '2000-12-31'))) +
  #coord_fixed(ratio=1.5) +
   xlab("Date") + ylab("Number of flights") + 
  ggtitle("Seasonal LAX air traffic in 2000")
gg4
```
  
    (c). Visualize and explain weekly effects.
    * Answer based on the flight in 2000
```{r}
week <- LAX2000 %>%
  group_by(dayofweek) %>%
  summarise(traffic_n = sum(n))
ggplot() +
  geom_bar(data = week, aes(x = dayofweek, y = traffic_n), stat = "identity")
```
  
    (d). Map top 10 destinations from LAX. Size of dots should reflect the number of flights from LAX to that destination.
    * Answer based on the flight in 2000
```{r}
LAX2000_dest1 <- inner_join(LAX2000_dest, airports_tbl,  
                        by = c("dest" = "faa"), copy = T) %>%
              ungroup() %>%
             select(dest, n, lat, lon) %>%
              collect()
```
```{r}
LAX2000_dest1$lat <- as.numeric(LAX2000_dest1$lat)
LAX2000_dest1$lon <- as.numeric(LAX2000_dest1$lon)
usa <- map_data("usa")
gg5 <- ggplot() + 
  geom_polygon(data = usa, aes(x = long, y = lat, group = group),
               fill = "seashell", color = "seashell3") + 
    coord_fixed(1.3) + 
  geom_point(data = LAX2000_dest1, aes(x = lon, y = lat, size = n, color = dest))
  
gg5
```
  
4. Build a predictive model for the arrival delay (`arrdelay`) of flights flying from LAX. Use the same filtering criteria as in the [lecture notes](http://hua-zhou.github.io/teaching/biostatm280-2018winter/slides/12-sparklyr/sparklyr-flights.html) to construct training and validation sets. You are allowed to use a maximum of 5 predictors. The prediction performance of your model on the validation data set will be an important factor for grading this question.
```{r}
system.time(
model_data <- flights_tbl %>%
    filter(origin == "LAX") %>%
    filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance)) %>%
    filter(depdelay > 15 & depdelay < 240) %>%
    filter(arrdelay > -60 & arrdelay < 360) %>%
    filter(year >= 2003 & year <= 2007) %>%
    left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>%
    mutate(hour = as.integer(crsdeptime / 100)) %>%
    select(year, month, dayofweek, arrdelay, depdelay, crsdeptime, distance, uniquecarrier, description, hour)
)
model_data
# Partition the data into training and validation sets
model_partition <- model_data %>% 
  sdf_partition(train = 0.8, valid = 0.2, seed = 5555)
system.time(
  ml1 <- model_partition$train %>%
    ml_linear_regression(arrdelay ~ distance + depdelay + dayofweek + hour)
)
system.time(
  ml2 <- model_partition$train %>%
    ml_linear_regression(arrdelay ~ distance + depdelay + dayofweek + hour + uniquecarrier)
)
# Summarize the linear model
summary(ml1)
summary(ml2)
```
* Assess model performance
```{r}
# Calculate average gains by predicted decile
system.time(
  model_deciles <- lapply(model_partition, function(x) {
    sdf_predict(ml2, x) %>%
      mutate(decile = ntile(desc(prediction), 10)) %>%
      group_by(decile) %>%
      summarize(arrdelay = mean(arrdelay)) %>%
      select(decile, arrdelay) %>%
      collect()
  })
)
model_deciles
# Create a summary dataset for plotting
deciles <- rbind(
  data.frame(data = 'train', model_deciles$train),
  data.frame(data = 'valid', model_deciles$valid),
  make.row.names = FALSE
)
deciles

# Plot average arrdelay by predicted decile
deciles %>%
  ggplot(aes(factor(decile), arrdelay, fill = data)) +
  geom_bar(stat = 'identity', position = 'dodge') +
  labs(title = 'Average arrdelay by predicted decile', x = 'Decile', y = 'Minutes')
```
* Visualize predictions
```{r}
# Select data from an out of time sample
data_2000 <- flights_tbl %>%
  filter(origin == "LAX") %>%
  filter(!is.na(arrdelay) & !is.na(depdelay) & !is.na(distance)) %>%
  filter(depdelay > 15 & depdelay < 240) %>%
  filter(arrdelay > -60 & arrdelay < 360) %>%
  filter(year == 2000) %>%
  left_join(airlines_tbl, by = c("uniquecarrier" = "code")) %>%
  mutate(hour = as.integer(crsdeptime / 100)) %>%
  select(year, month, dayofweek, arrdelay, depdelay, crsdeptime, distance, uniquecarrier, description, hour)
data_2000
```
```{r}
# Summarize data by carrier
carrier <- sdf_predict(ml1, data_2000)  %>%
   group_by(description) %>%
   summarize(arrdelay = mean(arrdelay, na.rm = T), prediction = mean(prediction, na.rm = T), freq = n()) %>%
   filter(freq > 100) %>%
  collect()
```

```{r}
# Plot actual and predicted arrival delay by airline carrier
ggplot(carrier, aes(arrdelay, prediction)) + 
  geom_point(alpha = 0.75, color = 'red', shape = 3) +
  geom_abline(intercept = 0, slope = 1, alpha = 0.15, color = 'blue') +
  geom_text(aes(label = substr(description, 1, 20)), size = 3, alpha = 0.75, vjust = -1) +
  labs(title='Average Arrival Delay Forecast', x = 'Actual', y = 'Predicted')
```
```{r}
# Prediction results for model 2
carrier2 <- sdf_predict(ml2, data_2000)  %>%
   group_by(description) %>%
   summarize(arrdelay = mean(arrdelay, na.rm = T), prediction = mean(prediction, na.rm = T), freq = n()) %>%
   filter(freq > 100) %>%
  collect()
```

```{r}
# Plot actual gains and predicted gains by airline carrier
ggplot(carrier2, aes(arrdelay, prediction)) + 
  geom_point(alpha = 0.75, color = 'red', shape = 3) +
  geom_abline(intercept = 0, slope = 1, alpha = 0.15, color = 'blue') +
  geom_text(aes(label = substr(description, 1, 20)), size = 3, alpha = 0.75, vjust = -1) +
  labs(title='Average Arrival Delay Forecast', x = 'Actual', y = 'Predicted')
```

    
5. Visualize and explain any other information you want to explore.


### Disconnect 
```{r}
spark_disconnect_all()
```
  
  